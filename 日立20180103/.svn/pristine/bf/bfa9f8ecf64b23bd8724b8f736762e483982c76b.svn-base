
@{
    ViewBag.Title = "采购合同验收处理";
    Layout = "~/Views/Shared/_EasyuiLayout.cshtml";
} 
@using Gmail.DDD.Config;
@section HeaderStyles{
    <style type="text/css">
    </style>
}
@section body{
    <div data-options="region:'north'">
        <div class="header">
            <div class="left-layout">
                <a hrer="javascript:;" class="btn-back">返回</a>
                <h1>采购合同验收</h1>
            </div>
            <div class="center-layout"></div>
            <div id="BtnGroup" class="right-layout">  
                <a href="javascript:;" class="easyui-linkbutton" id="test">模拟采购支付处理审核通过</a>
                <a href="javascript:;" class="easyui-linkbutton" id="AdmitYSCL_121" disabled="true">承认</a>
                <a href="javascript:;" class="easyui-linkbutton" id="ChangeYSCL_121">变更</a>
                <a href="javascript:;" class="easyui-linkbutton" id="CancelYSCL_121">取消</a>
                <a href="javascript:;" class="easyui-linkbutton" id="DetailYSCL_121" disabled="true">详情</a> 
                <a href="javascript:;" class="easyui-linkbutton" id="SaveYSCL_121" disabled="true">保存</a>
                <a href="javascript:;" class="easyui-linkbutton" id="HandeYSCL_121" disabled="true" >处理</a>
                <a href="javascript:;" class="easyui-linkbutton" id="DelYSCL_121"  disabled="true">删除</a>
            </div>
        </div>
    </div>
    <div data-options="region:'center'">
        <div class="easyui-layout">
            <div data-options="region:'west',split:true,width:230">
                <div class="easyui-layout">
                    <div data-options="region:'center'">
                        <div class="nano">
                            <div class="nano-content">
                                <ul id="szrl105Tree" style="margin:10px;"></ul>
                            </div>
                        </div>
                    </div>
                    <div data-options="region:'north'">
                        <div class="tree-search">
                            <div id="forsomesearch" class="search-layout">
                                <input id="searchTree" class="easyui-searchbox" style="width:100%" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div data-options="region:'center'">
                <div class="easyui-layout">
                    <div data-options="region:'center'">
                        <div id="tt" class="easyui-tabs">
                            <div title="验收信息">
                                <div class="nano">
                                    <div class="nano-content">
                                        <div class="control-group" id="tt_0">
                                            <div class="control-group-content">
                                                <div class="control-text"><label>作番号：</label><p style="min-width:13em;" id="zuofanhao"></p></div>
                                                <div class="control-text"><label>合同号：</label><p style="min-width:13em;" id="hetonghao"></p></div>
                                                <div class="control-text"><label>合同金额：</label><p style="min-width:13em;" id="hetongjine"></p></div>
                                                <br />
                                                <div class="control-text"><label>合同内容：</label><p style="min-width:23em;" id="hetongneirong"></p></div>
                                                <div class="control-text"><label>供应商：</label><p style="min-width:22em;" id="gongyingshang"></p></div><br />
                                                <br />
                                                @*<div class="control-text"><label>制单人：</label><p style="min-width:12em;" id=""></p></div>
                                                <div class="control-text"><label>制单日期：</label><p style="min-width:12em;" id=""></p></div>
                                                <div class="control-text"><label>审核人：</label><p style="min-width:12em;" id=""></p></div>
                                                <div class="control-text"><label>审核日期：</label><p style="min-width:12em;" id=""></p></div>*@
                                            </div>
                                        </div>
                                        <div style="margin:20px 23px 0 20px;border-bottom:none;">
                                            <table id="YJH_Grid"  cellpadding="0" cellspacing="0" style="width:1100px;min-height:100px;text-align:center;border-bottom:none;">
                                               
                                            </table>
                                        </div>
                                        <div style="margin:0px 23px 0 20px;">
                                            <table id="BCJH_Grid" cellpadding="0" cellspacing="0" style="width:1100px;min-height:100px;text-align:center;">
                                                 
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div title="附件">
                                等桑大侠的附件模块
                            </div>
                            <div title="协同办公">
                                等桑大侠的协同办公模块
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div id="FilesUpload_121" class="easyui-window" title="附件" data-options="modal:true" closed="true" collapsible="false" style="width:60%;height:50%;padding-bottom:10px;">
        @Html.Partial("TComponent/FileUpload/_sdpk007_ux_Upload")
    </div>

    <div id="PlanTips_121" class="easyui-window" title="有验收计划但未处理" data-options="modal:true" closed="true" collapsible="false" style="width:55%;height:35%;">
        <table id="PlanTips_121_grid">
            <thead>
                <tr>
                    <th data-options="field: 'rl01806',align:'center',width:100">作番号</th>
                    <th data-options="field: 'rl10505',align:'center',width:100">采购合同号</th>
                    <th data-options="field: 'rl10522',align:'center',width:100">合同金额</th>
                    <th data-options="field: 'rl10605',align:'center',width:120">合同内容</th>
                    <th data-options="field: 'rl12106',align:'center',width:100">计划验收日期</th> 
                    <th data-options="field: 'rl12107',align:'center',width:100">本次验收百分比</th>
                    <th data-options="field: 'rl12108',align:'center',width:100">本次验收金额</th>
                </tr>
            </thead>
        </table>
    </div>
}

@section FooterScript{
    <script>
        (function () {
            $(function () {
                //当前编辑行索引
                var editIndex = undefined;
                //合同金额
                var Hetongjine_121 = 0;   //到时候用ViewData[""]保存金额
                //作番ID
                var zuofanid = '';               //cmt
                //采购合同ID
                var caigouhetongid = "";  //cmt
                //表单是否可以编辑
                var CanEdit121Grid = false;
                //当前页面所有记录百分比总和 cmtps:改为0，到时候上面那个grid加载的时候为这个字段赋值
                var _szrl121bfb = 0;
                //当前页面所有记录金额总和 cmtps:改为0，到时候上面那个grid加载的时候为这个字段赋值
                var _szrl121je = 0;
                var type = '@ViewData["type"]';
                var chuantouIP = '@PM2Config.Instance.GetSetting("ChuanTouIP_116")'


                function endEditing() {
                    if (editIndex == undefined) { return true }
                    if ($('#BCJH_Grid').datagrid('validateRow', editIndex)) {
                        $('#BCJH_Grid').datagrid('endEdit', editIndex);
                        editIndex = undefined;
                        return true;
                    } else {
                        return false;
                    }
                }
                //页面选择行
                onClick121Row = function (index) {
                    //如果是第一行，一定是今回验收，则关闭编辑器
                    JinHuiYanShou(index);
                    if (CanEdit121Grid) {       //到时候要判断是查看还是什么
                        if (endEditing()) {
                            $('#BCJH_Grid').datagrid('selectRow', index)
                                .datagrid('beginEdit', index);
                            editIndex = index;
                        } else {
                            $('#BCJH_Grid').datagrid('selectRow', editIndex);
                        }
                    }
                }

                //绑定基础数据
                BindBasicData = function () {
                    $.ajax({
                        url: "/AreasCode030/szrl121/BindBasicData",
                        data: {
                            caigouhetongid: caigouhetongid,
                            type: type,
                            zuofanid: zuofanid
                        },
                        type: "post",
                        success: function (obj) {
                            if (obj.success) {
                                Hetongjine_121 = obj.rl10522;
                                zuofanid = obj.rl10502;
                                $("#zuofanhao").text(obj.rl10502);
                                $("#hetonghao").text(obj.rl10505);
                                $("#hetongjine").text(obj.rl10522);
                                $("#hetongneirong").text(obj.rl10605);
                                $("#gongyingshang").text(obj.rl10510);
                            }
                            else { alert("系统出错，请联系管理员！"); }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });
                }


                //页面的保存按钮
                $("#SaveYSCL_121").click(function () {
                    Save121GridData();
                    debugger;
                    //保存之前判断所有的日期、比例、金额是否正确
                    var rows = $('#BCJH_Grid').datagrid('getRows');
                    debugger;
                    var Str = "";
                    var SumRate = 0;
                    var SumJinE = 0;
                    for (var i = 0; i < rows.length; i++) {
                        if (rows[i]['rl12106'].toString() == "" && rows[i]['rl12103'].toString() =="") {
                            Str = "第" + (i + 1) + "行,请选择検収日期";
                            alert(Str);
                            return false;
                        }
                        if (rows[i]['rl12107'].toString() == "") {
                            if (i > 1 || i ==0) {
                                Str = "第" + (i + 1) + "行,请输入比例";
                                alert(Str);
                                return false;
                            }
                        }
                        if (rows[i]['rl12108'].toString() == "") {
                            if (i > 1 || i ==0) {
                                Str = "第" + (i + 1) + "行,请输入金额";
                                alert(Str);
                                return false;
                            }
                        }
                        if (i >= 2) {
                            if (rows[0]['rl12106'].toString() != "" && rows[i]['rl12106'].toString() != "") {
                                //日期判断还有问题，要判断月份，这里只是判断了大于当前日期而已
                                var nextMonth = getNextMonth(rows[i]['rl12106'].toString());
                                if (i + 1 <= rows.length - 1 && new Date(Date.parse(nextMonth)) >= new Date(Date.parse(rows[i + 1]['rl12106'].toString()))) {
                                    Str = "本次实际验收/后续修正计划中的月份错误，请检查";
                                    $.messager.show({
                                        title: '不能保存',
                                        msg: Str,
                                    });
                                    return false;
                                }
                            }
                        }
                        SumRate += (rows[i]['rl12107'] == "" ? 0 : parseFloat(rows[i]['rl12107']));
                        SumJinE += (rows[i]['rl12108'] == "" ? 0 : parseFloat(rows[i]['rl12108']));
                    }
                    if (SumRate + _szrl121bfb != 100) {
                        $.messager.show({
                            title: '不能保存',
                            msg: '验收比例必须等于100%',
                        });
                        return false;
                    }
                    if (SumJinE + _szrl121je != Number(Hetongjine_121)) {
                        $.messager.show({
                            title: '不能保存',
                            msg: '金额必须等于合同金额',
                        });
                        return false;
                    }
                    //当所有校验都通过的时候，保存进数据库
                    $.ajax({
                        url: "/AreasCode030/szrl121/Insert121",
                        data: {
                            BCJH_Grid_data: JSON.stringify($('#BCJH_Grid').datagrid('getRows')),
                            type: type,
                            caigouhetongid: caigouhetongid
                        },
                        type: "post",
                        success: function (data) {
                            var obj = $.parseJSON(data);
                            if (obj.success) {
                                alert("保存成功！");
                                //cmtps ：到时候还要刷新页面
                                Refresh_121Data();
                            }
                            else { alert("系统出错，请联系管理员！"); }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });
                });
                //页面的处理按钮
                $("#HandeYSCL_121").click(function () {
                    CanEdit121Grid = true;
                    $("#DelYSCL_121").linkbutton('enable');
                });
                //页面的删除按钮
                $("#DelYSCL_121").click(function () {
                    Refresh_121Data();
                });
                //页面的变更按钮
                $("#ChangeYSCL_121").click(function () {

                });
                //页面的承认按钮
                $("#AdmitYSCL_121").click(function () {
                    $.ajax({
                        url: "/AreasCode030/szrl121/AdmitByYSCL",
                        data: {
                            caigouhetongid: caigouhetongid,
                            type: type,
                            zuofanid: zuofanid
                        },
                        type: "post",
                        success: function (data) {
                            var obj = $.parseJSON(data);
                            if (obj.success) {
                                alert("承认成功！");
                                Refresh_121Data();
                            }
                            else { alert("系统出错，请联系管理员！"); }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });
                });
                //页面的详情按钮
                $("#DetailYSCL_121").click(function () {
                    $.ajax({
                        url: "/AreasCode030/szrl121/XQ_121",
                        data: {
                            caigouhetongid: caigouhetongid,
                            type: type,
                            zuofanid: zuofanid
                        },
                        type: "post",
                        async: false,
                        success: function (data) {
                            var obj = $.parseJSON(data);
                            if (obj.success) {
                                //【obj.Message主表105ID】
                                var str_ip = chuantouIP + '/CustomForm/RLCGGL/szrl105/szrl105Edit.aspx?sd_billId=' + obj.Message;
                                window.open(str_ip);
                            }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });
                });
                //点击附件列方法
                AttachFiles_121 = function (value, id, index,TorF) {
                    debugger;
                    $("#FilesUpload_121").window('open');
                    if (TorF) {
                        window.sdpk007_ux_WinClass.Init(id, true);
                        window.sdpk007_ux_WinClass.Load();
                    }
                    else
                    {
                        window.sdpk007_ux_WinClass.Init(id, false);
                        window.sdpk007_ux_WinClass.Load();
                    }
                }
                //添加一行
                function append121Row() {
                    if (endEditing()) {
                        $('#BCJH_Grid').datagrid('appendRow', {
                            rl12102: 3,
                            rl12103: '',
                            rl12104: 0,
                            rl12105: 0,
                            rl12106: '',
                            rl12107: 0,
                            rl12108: 0,
                            rl12109: '',
                            rl12110: '',
                            rl12111: 0,
                            rl12120: zuofanid,
                            rl12121: caigouhetongid
                        });
                        editIndex = $('#BCJH_Grid').datagrid('getRows').length - 1;
                        //$('#BCJH_Grid').datagrid('selectRow', editIndex)
                        //    .datagrid('beginEdit', editIndex);
                    }
                }
                window.onload = function () {
                    //Update121();
                    Bind121TipsData();
                    //绑定下部分grid
                    $("#BCJH_Grid").datagrid({
                        url: "/AreasCode030/szrl121/QueryGridDataFor121", 
                        rownumbers: true,
                        singleSelect: true,
                        onClickRow: onClick121Row,
                        showFooter: true,
                        toolbar: [
                            {
                                id: "icon121_add",
                                text: '新增行',
                                iconCls: 'icon-add',
                                handler: function () {
                                    append121Row();
                                }
                            },
                        ],
                        columns: [
                            [
                                { title: '原定验收日期', colspan: 4 },
                                { title: '本次实际验收/后续修正计划', colspan: 5 },
                                { title: '' }
                            ],
                            [
                                {
                                    field: 'rl12102', title: '検収済', align: 'center', width: 150,
                                    formatter: function (value, row) {
                                        if (value == '1') { return '今回検収'; }
                                        if (value == '2') { return '今月再度検収予定'; }
                                        if (value == '3') { return '来月以後検収予定'; }
                                        else { return value; }
                                    }
                                },
                                {
                                    field: 'rl12103', title: '日期', align: 'center', width: 100,
                                    formatter: function (value, row, index) {
                                        if (value.length == 10) {
                                            return value.substring(0, 7);
                                        }
                                        else { return value; }
                                    }
                                },
                                {
                                    field: 'rl12104', title: '%', align: 'center', width: 100,
                                    formatter: function (value, row) {
                                        return toDecimal2(value) + '%'
                                    }
                                },
                                {
                                    field: 'rl12105', title: '金额', align: 'center', width: 100,
                                    formatter: function (value, row) {
                                        return toDecimal2(value);
                                    }
                                },
                                {
                                    field: 'rl12106', title: '検収日期', align: 'center', width: 100,
                                    formatter: function (value, row, index) {
                                        if (index == 0) {
                                            return value;
                                        }
                                        else {
                                            if (value.length == 10) {
                                                return value.substring(0, 7);
                                            }
                                            else { return value; }
                                        }
                                    },
                                    editor: { type: 'datebox' }
                                },
                                {
                                    field: 'rl12107', title: '%', align: 'center', width: 100,
                                    formatter: function (value, row, index) {
                                        if (index == 0 || index == 1) { return value + '%'; }
                                        else {
                                            if (value == 0) { return ''; }
                                            else { return value + '%'; }
                                        }
                                    },
                                    editor: { type: 'numberbox', options: { precision: 2 } }
                                },
                                {
                                    field: 'rl12108', title: '金额', align: 'center', width: 100,
                                    editor: { type: 'numberbox', options: { precision: 2 } },
                                    formatter: function (value, row, index) {
                                        if (index == 0 || index == 1) { return value; }
                                        else {
                                            if (value == 0) { return ''; }
                                            else { return value; }
                                        }
                                    }
                                },
                                {
                                    field: 'rl12109', title: '附件', align: 'center', width: 50,
                                    formatter: function (value, row, index) {
                                        var a = row['rl12101'];
                                        var b = row['rl12102'];
                                        if (index == 0 && b == 1) { return "<a href='#' onclick='AttachFiles_121(\"" + value + "\",\"" + a + "\",\"" + index + "\",true)'>···</a>"; }
                                    }
                                },
                                {
                                    field: 'rl12110', title: '备注', align: 'center', width: 150,
                                    editor: { type: 'textbox' }
                                },
                                {
                                    field: 'rl12111', title: '状态', align: 'center', width: 100,
                                    formatter: function (value, row) {
                                        if (value == 0) { return '未提出'; }
                                        if (value == 1) { return '提出済'; }
                                        if (value == 2) { return '承認済'; }
                                        if (value == 3) { return '调达处理中'; }
                                        if (value == 4) { return '检收完了'; }
                                        if (value == 5) { return 'AP発行済'; }
                                    }
                                },
                            ]
                        ],
                        onLoadSuccess: function (data) {
                            var _sumJine = 0;
                            for (var i = 0; i < data.rows.length; i++) {
                                _sumJine += data.rows[i]['rl12108'];
                            }
                            if (_sumJine == 0) {
                                CanEdit121Grid = false;
                            }
                            if (data.rows[0]['rl12111'] == 0)
                            {
                                $("#AdmitYSCL_121").linkbutton("disable");
                                $("#SaveYSCL_121").linkbutton("enable");
                                $("#HandeYSCL_121").linkbutton("enable");
                            }
                            if (data.rows[0]['rl12111'] == 1 || data.rows[0]['rl12111'] == 2) {
                                $("#SaveYSCL_121").linkbutton("disable");
                                $("#HandeYSCL_121").linkbutton("disable");
                                $("#DelYSCL_121").linkbutton("disable");
                                $("#AdmitYSCL_121").linkbutton("enable");
                                $("#icon121_add").linkbutton("disable");
                                if (data.rows[0]['rl12111'] == 2) {
                                    alert("上次验收未支付处理，请联系采购进行处理");
                                    $("#AdmitYSCL_121").linkbutton("disable");
                                }
                            }
                        },
                        onBeginEdit: function (rowIndex, rowData) {
                            var editors = $('#BCJH_Grid').datagrid('getEditors', rowIndex);
                            if (rowIndex == 0 || rowIndex == 1) {
                                var Row0Editor = editors[0];
                                var Row1Editor = editors[1];
                                var row = $('#BCJH_Grid').datagrid('getRows')[rowIndex];
                                Row0Editor.target.numberbox({
                                    onChange: function (newValue, oldValue) {
                                        Row1Editor.target.numberbox('setValue', newValue * Hetongjine_121 / 100);
                                        row['rl12107'] = newValue;
                                        row['rl12108'] = newValue * Hetongjine_121 / 100;
                                    }
                                });
                                Row1Editor.target.numberbox({
                                    onChange: function (newValue, oldValue) {
                                        Row0Editor.target.numberbox('setValue', newValue / Hetongjine_121 * 100)
                                        row['rl12107'] = newValue / Hetongjine_121 * 100;
                                        row['rl12108'] = newValue;
                                    }
                                });
                            }
                            else {
                                var Row1Editor = editors[1];
                                var Row2Editor = editors[2];
                                var row = $('#BCJH_Grid').datagrid('getRows')[rowIndex];
                                Row1Editor.target.numberbox({
                                    onChange: function (newValue, oldValue) {
                                        Row2Editor.target.numberbox('setValue', newValue * Hetongjine_121 / 100);
                                        row['rl12107'] = newValue;
                                        row['rl12108'] = newValue * Hetongjine_121 / 100;
                                    }
                                });
                                Row2Editor.target.numberbox({
                                    onChange: function (newValue, oldValue) {
                                        Row1Editor.target.numberbox('setValue', newValue / Hetongjine_121 * 100)
                                        row['rl12107'] = newValue / Hetongjine_121 * 100;
                                        row['rl12108'] = newValue;
                                    }
                                });
                            }
                        }
                    });
                    //绑定上部分grid
                    $("#YJH_Grid").datagrid({
                        url: "/AreasCode030/szrl121/QueryTopGridDataFor121", 
                        rownumbers: true,
                        singleSelect: true,
                        showFooter: true,
                        columns: [[
                            {
                                field: 'rl12102', align: 'center', width: 150,
                                formatter: function (value, row) {
                                    if (value == '0') { return '检收济'; }
                                    if (value == '1') { return '今回検収'; }
                                    if (value == '2') { return '今月再度検収予定'; }
                                    if (value == '3') { return '来月以後検収予定'; }
                                    else { return value; }
                                }
                            },
                            { field: 'rl12103', title: '日期', align: 'center', width: 100 },
                            {
                                field: 'rl12104', title: '%', align: 'center', width: 100,
                                formatter: function (value, row) {
                                    return toDecimal2(value) + '%'
                                }
                            },
                            { field: 'rl12105', title: '金额', align: 'center', width: 100 },
                            { field: 'rl12106', title: '検収日期', align: 'center', width: 100 },
                            {
                                field: 'rl12107', title: '%', align: 'center', width: 100,
                                formatter: function (value, row) {
                                    return toDecimal2(value) + '%'
                                }
                            },
                            { field: 'rl12108', title: '金额', align: 'center', width: 100 },
                            {
                                field: 'rl12109', title: '附件', align: 'center', width: 50,
                                formatter: function (value, row, index) {
                                    var a = row['rl12101'];
                                    var b = row['rl12102'];
                                    if (b == 0) {
                                        return "<a href='#' onclick='AttachFiles_121(\"" + value + "\",\"" + a + "\",\"" + index + "\",false)'>···</a>";
                                    }
                                }
                            },
                            { field: 'rl12110', title: '备注', align: 'center', width: 150 },
                            {
                                field: 'rl12111', title: '状态', align: 'center', width: 100,
                                formatter: function (value, row) {
                                    if (value == 0) { return '未提出'; }
                                    if (value == 1) { return '提出済'; }
                                    if (value == 2) { return '承認済'; }
                                    if (value == 3) { return '调达处理中'; }
                                    if (value == 4) { return '检收完了'; }
                                    if (value == 5) { return 'AP発行済'; }
                                }
                            }
                        ]],
                        onLoadSuccess: function (data) {
                            for (var i = 0; i < data.rows.length; i++) {
                                _szrl121bfb += data.rows[i]['rl12107'];
                                _szrl121je += data.rows[i]['rl12108'];
                            }
                            if (data.rows.length > 0)
                            { CanEdit121Grid = false; }
                            if (_szrl121bfb == 100) {
                                $("#HandeYSCL_121").linkbutton('disable');
                                $("#AdmitYSCL_121").linkbutton('disable');
                                $("#SaveYSCL_121").linkbutton('disable');
                            }
                        }
                    }); 
                }
                //绑定【有验收计划但未处理】window数据
                Bind121TipsData = function () {
                    $("#PlanTips_121_grid").datagrid({
                        url: "/AreasCode030/szrl121/QueryOverTimeData",
                        queryParams: {
                            caigouhetongid: caigouhetongid,
                            type: type,
                            zuofanid: zuofanid
                        },
                        pagination: true,
                        fit: true,
                        rownumbers: true,
                        fitColumns: false,
                        singleSelect: true,
                        idField: 'rl12121',
                        showFooter: true,
                        onClickRow: onClick121TipsRow,
                        onLoadSuccess: function (data) {
                            if (data.rows.length > 0 && caigouhetongid =="")
                            {
                                $("#PlanTips_121").window("open");
                            }
                        }
                    });
                };
                //选中提示数据
                onClick121TipsRow = function (index) {
                    var selected = $('#PlanTips_121_grid').datagrid('getSelected');
                    if (selected) {
                        caigouhetongid = selected["rl12121"];
                        var node = $('#szrl105Tree').tree('find', caigouhetongid);
                        $('#szrl105Tree').tree('expandTo', node.target).tree('select', node.target);
                        Refresh_121Data();
                        $("#PlanTips_121").window("close");
                        $("#DetailYSCL_121").linkbutton('enable');
                    }
                }
                //控制按钮是否可用
                Contro121Btn = function () {
                    $.ajax({
                        url: "/AreasCode030/szrl121/Contro121Btn",
                        data: {
                            caigouhetongid: caigouhetongid 
                        },
                        type: "post",
                        success: function (data) {
                            var obj = $.parseJSON(data);
                            if (obj.success) {
                                if (obj.Pamrms.Status == "true") {
                                    $("#SaveYSCL_121").linkbutton("disable");
                                    $("#AdmitYSCL_121").linkbutton("enable");
                                    $("#HandeYSCL_121").linkbutton("disable");
                                    CanEdit121Grid = false;
                                    alert(obj.Pamrms.Msg);
                                }
                            }
                            else { alert("系统出错，请联系管理员！"); }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });

                }
                //保存数据并退出编辑
                Save121GridData = function () {
                    //取消选中当前的行
                    if (editIndex != undefined) {
                        $("#BCJH_Grid").datagrid("unselectRow", editIndex);
                    }
                    //edit_035_grid退出编辑，保存好数据
                    $('#BCJH_Grid').datagrid('endEdit', editIndex);
                };
                //关闭编辑器
                JinHuiYanShou = function (index) {
                    if (index == 0 || index == 1) {
                        var e = $("#BCJH_Grid").datagrid('getColumnOption', "rl12106");
                        e.editor = {};
                    }
                    else {
                        var e = $("#BCJH_Grid").datagrid('getColumnOption', "rl12106");
                        e.editor = { type: 'datebox' };
                    }
                }
                //制保留2位小数，如：2，会在2后面补上00.即2.00
                function toDecimal2(x) {
                    var f = parseFloat(x);
                    if (isNaN(f)) {
                        return false;
                    }
                    var f = Math.round(x * 100) / 100;
                    var s = f.toString();
                    var rs = s.indexOf('.');
                    if (rs < 0) {
                        rs = s.length;
                        s += '.';
                    }
                    while (s.length <= rs + 2) {
                        s += '0';
                    }
                    return s;
                }
                $('#szrl105Tree').tree({
                    url: '/AreasCode030/szrl121/TreeLoad',
                    animate: true,
                    onClick: function (node) {
                        debugger;
                        $(this).tree('expand', node.target);
                        if (node.attributes) {
                            var nodemessage = node.attributes.nodeType;//获取作番号
                            if (nodemessage != "szrl001" && nodemessage != "szrl004" && nodemessage != "szrl018") {
                                var selectedNode = $('#szrl105Tree').tree('getSelected');
                                caigouhetongid = selectedNode.id;
                                Refresh_121Data();
                                $("#DetailYSCL_121").linkbutton('enable');
                            }
                        }
                    },
                    onCollapse: function (node) {
                        $(this).tree('collapseAll', node.target);
                    }
                });
                Refresh_121Data = function () { 
                    BindBasicData();
                    $("#BCJH_Grid").datagrid('reload', {
                        caigouhetongid: caigouhetongid
                    });
                    $("#YJH_Grid").datagrid('reload', {
                        caigouhetongid: caigouhetongid
                    });
                    //Contro121Btn();
                }
                //获取下一个月 
                function getNextMonth(date) {
                    var arr = date.split('-');
                    var year = arr[0]; //获取当前日期的年份
                    var month = arr[1]; //获取当前日期的月份
                    var day = arr[2]; //获取当前日期的日
                    var days = new Date(year, month, 0);
                    days = days.getDate(); //获取当前日期中的月的天数
                    var year2 = year;
                    var month2 = parseInt(month) + 1;
                    if (month2 == 13) {
                        year2 = parseInt(year2) + 1;
                        month2 = 1;
                    }
                    var day2 = day;
                    var days2 = new Date(year2, month2, 0);
                    days2 = days2.getDate();
                    if (day2 > days2) {
                        day2 = days2;
                    }
                    if (month2 < 10) {
                        month2 = '0' + month2;
                    }

                    var t2 = year2 + '-' + month2 + '-' + day2;
                    return t2;
                }


                Update121 = function () {
                    $.ajax({
                        url: "/AreasCode030/szrl121/Update121",
                        data: {
                            caigouhetongid: caigouhetongid,
                            type: type,
                            zuofanid: zuofanid
                        },
                        type: "post",
                        success: function (data) {
                            var obj = $.parseJSON(data);
                            if (obj.success) {
                            }
                            else { alert("系统出错，请联系管理员！"); }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });
                }
                //到时候要删掉的 cmt
                $("#test").click(function () {
                    $.ajax({
                        url: "/AreasCode030/szrl121/AdmitByPayPlan",
                        data: {
                            caigouhetongid: caigouhetongid,
                            type: type
                        },
                        type: "post",
                        success: function (data) {
                            var obj = $.parseJSON(data);
                            if (obj.success) {
                                alert("承认成功！");
                                Refresh_121Data();
                            }
                            else { alert("系统出错，请联系管理员！"); }
                        },
                        error: function (obj) { alert("系统出错，请联系管理员！"); }
                    });
                });
              
            });
        }());
    </script>
}

