(function(n){var t,i=null,e=n("#uploader"),u=n('<ul class="filelist"><\/ul>').appendTo(e.find(".queueList")),f=e.find(".statusBar"),s=f.find(".info"),r=e.find(".uploadBtn"),h=e.find(".placeholder"),o=f.find(".progress").hide(),c=function(){t=this;var e=null;WebUploader.Uploader.register({"before-send-file":"beforeSendFile","before-send":"beforeSend","after-send-file":"afterSendFile"},{beforeSendFile:function(n){e=t.GetFileQueued(n.id)},beforeSend:function(t){var i=n.Deferred(),r,o,u,f;if(e.file.isUpload)i.reject();else if(e.file.chunks&&e.file.chunks.length>0){for(r=null,o=t.end-t.start,u=0;u<e.file.chunks.length;u++)if(f=e.file.chunks[u],t.chunk==f.name){r=f;break}r&&r.size==o?i.reject():i.resolve()}else i.resolve();return i.promise()},afterSendFile:function(){}});i=WebUploader.create({swf:"/Content/TComponent/webuploader/Uploader.swf",pick:{id:"#filePicker",innerHTML:"点击选择文件",multiple:!0},auto:!1,fileVal:"HttpFile",method:"POST",server:"/AreasCode019/FileUpload/UploadAsync",compress:!1,disableGlobalDnd:!0,dnd:"#dndArea",paste:"#uploader",chunked:!0,chunkSize:3145728,chunkRetry:2,threads:1,fileNumLimit:100,fileSingleSizeLimit:104857600,prepareNextFile:!1,duplicate:!1});i.addButton({id:"#filePicker2",innerHTML:"继续添加"});i.on("fileQueued",function(r){t.fileCount++;t.fileSize+=r.size;t.fileCount===1&&(h.addClass("element-invisible"),f.show());t.AddFile(r);t.setState("ready");t.updateTotalProgress();i.md5File(r).progress(function(t){var i=n("#"+r.id),u=i.find(".progress_check>span").text(parseInt(t*100))}).then(function(i){var u=n("#"+r.id);n.ajax({type:"POST",url:"/AreasCode019/FileUpload/UploadAsync",async:!1,data:{md5:i,md5name:i+"."+r.ext,size:r.size,OperationState:"FileInfo"},dataType:"json",success:function(n){n.success&&(t.FileQueueds.push({id:r.id,md5:i,name:r.name,md5name:i+"."+r.ext,size:r.size,isUpload:n.Pamrms.isUpload,chunks:n.Pamrms.chunks}),u.find(".progress_check").attr("data-checkedcomplete",!0).text("验证完成，等待上传").css("color","#aaa"))},error:function(){}})})});i.on("fileDequeued",function(n){t.fileCount--;t.fileSize-=n.size;t.fileCount||t.setState("pedding");t.RemoveFile(n);t.updateTotalProgress()});r.on("click",function(){if(n(this).hasClass("disabled"))return!1;if(u.find(".progress_check[data-checkedcomplete=false]").length>0)return n.messager.alert("友情提示","请等待文件验证完成!","warning"),!1;u.find(".progress_check").hide();t.state==="ready"?i.upload():t.state==="paused"?i.upload():t.state==="uploading"&&i.stop()});i.on("uploadBeforeSend",function(n,t){t.md5=e.file.md5;t.chunk=n.chunk;t.chunks=n.chunks;t.chunkSize=n.end-n.start;t.md5name=e.file.md5name;t.name=e.file.name;t.size=e.file.size});i.on("uploadSuccess",function(i){var r=t.GetFileQueued(i.id);n.ajax({type:"POST",url:"/AreasCode019/FileUpload/UploadAsync",async:!1,data:{fk:t.fk,md5:r.file.md5,name:i.name,md5name:r.file.md5name,size:i.size,OperationState:"FileMerge"},dataType:"json",success:function(u){if(u.success){t.FileQueueds[r.index].isUpload=!0;t.FileQueueds[r.index].chunks=[];n(".pop-window0 .pop-close").click();var f={pk:u.Pamrms.pk00801,pk00803:i.name,pk00805:u.Pamrms.pk00805,pj00402:u.Pamrms.pk00807};window.opener.sdpk007_ux_WinClass.Add(f)}else n.messager.alert("友情提示",u.Message,"error")},error:function(){}})});i.on("uploadProgress",function(i,r){var u=n("#"+i.id),f=u.find(".progress span");f.css("width",r*100+"%");t.percentages[i.id][1]=r;t.updateTotalProgress()});i.on("all",function(n){switch(n){case"uploadFinished":t.setState("confirm");break;case"startUpload":t.setState("uploading");break;case"stopUpload":t.setState("paused")}});s.on("click",".retry",function(){i.retry()});s.on("click",".ignore",function(){});r.addClass("state-"+t.state);t.updateTotalProgress()};c.prototype={fk:undefined,fileCount:0,fileSize:0,state:"pedding",percentages:{},FileQueueds:[],GetFileQueued:function(n){for(var i=0;i<t.FileQueueds.length;i++)if(t.FileQueueds[i].id==n)return{index:i,file:t.FileQueueds[i]}},SetPk:function(n){t.fk=n},AddFile:function(r){var f=n('<li id="'+r.id+'"><p class="title">'+r.name+'<\/p><p class="imgWrap"><\/p><p class="progress"><span><\/span><\/p><p class="progress_check" data-checkedcomplete="false">正在验证文件：<span>0<\/span>%<\/p><\/li>'),o=n('<div class="file-panel"><span class="cancel">删除<\/span><span class="rotateRight">向右旋转<\/span><span class="rotateLeft">向左旋转<\/span><\/div>').appendTo(f),s=f.find("p.progress span"),e=f.find("p.imgWrap"),h=n('<p class="error"><\/p>'),c=function(n){switch(n){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}h.text(text).appendTo(f)};if(r.getStatus()==="invalid")c(r.statusText);else{e.text("预览中");var l=window.devicePixelRatio||1,a=110*l,v=110*l;i.makeThumb(r,function(t,i){var f,u,o;if(t){e.text("不能预览");u="file-text-icon.png";switch(r.ext.toLowerCase()){case"doc":case"docx":u="doc_files.png";break;case"txt":u="txt_files.png";break;case"zip":u="zip_files.png";break;case"rar":u="rar_files.png";break;case"xls":case"xlsx":u="excel.png";break;case"rar":u="rar_files.png"}o="<img src='/Content/Areas/AreasCode019/FileUpload/image/"+u+"'>";e.empty().append(n(o));return}f=n('<img src="'+i+'">');e.empty().append(f)},a,v);t.percentages[r.id]=[r.size,0];r.rotation=0}r.on("statuschange",function(n,i){i==="progress"?s.hide().width(0):i==="queued"&&(f.off("mouseenter mouseleave"),o.remove());n==="error"||n==="invalid"?(c(r.statusText),t.percentages[r.id][1]=1):n==="interrupt"?c("interrupt"):n==="queued"?(h.remove(),s.css("display","block"),t.percentages[r.id][1]=0):n==="progress"?(h.remove(),s.css("display","block")):n==="complete"&&(s.hide().width(0),f.append('<span class="success"><\/span>'));f.removeClass("state-"+i).addClass("state-"+n)});f.on("mouseenter",function(){o.stop().animate({height:30})});f.on("mouseleave",function(){o.stop().animate({height:0})});o.on("click","span",function(){var u=n(this).index(),t;switch(u){case 0:i.removeFile(r);return;case 1:r.rotation+=90;break;case 2:r.rotation-=90}t="rotate("+r.rotation+"deg)";e.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})});f.appendTo(u)},RemoveFile:function(i){var r=n("#"+i.id);delete t.percentages[i.id];t.updateTotalProgress();r.off().find(".file-panel").off().end().remove();t.FileQueueds&&t.FileQueueds.length>0&&t.FileQueueds.splice(t.GetFileQueued(i.id).index,1)},setState:function(e){var s;if(e!==t.state){r.removeClass("state-"+t.state);r.addClass("state-"+e);t.state=e;switch(t.state){case"pedding":h.removeClass("element-invisible");u.hide();f.addClass("element-invisible");i.refresh();break;case"ready":h.addClass("element-invisible");n("#filePicker2").removeClass("element-invisible");u.show();f.removeClass("element-invisible");i.refresh();break;case"uploading":n("#filePicker2").addClass("element-invisible");o.show();r.text("暂停上传");break;case"paused":n.each(i.getFiles(),function(n,t){t.getStatus()=="progress"&&t.setStatus("interrupt")});o.show();r.text("继续上传");break;case"confirm":if(o.hide(),n("#filePicker2").removeClass("element-invisible"),r.text("开始上传"),s=i.getStats(),s.successNum&&!s.uploadFailNum){t.setState("finish");return}break;case"finish":s=i.getStats();s.successNum||(t.state="done",location.reload())}t.updateStatus()}},updateStatus:function(){var r="",n;t.state==="ready"?r="选中"+t.fileCount+"个文件，共"+WebUploader.formatSize(t.fileSize)+"。":t.state==="confirm"?(n=i.getStats(),n.uploadFailNum&&(r="已成功上传"+n.successNum+"个文件，"+n.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传<\/a>失败文件或<a class="ignore" href="#">忽略<\/a>')):(n=i.getStats(),r="共"+t.fileCount+"个（"+WebUploader.formatSize(t.fileSize)+"），已上传"+n.successNum+"个",n.uploadFailNum&&(r+="，失败"+n.uploadFailNum+"个"));s.html(r)},updateTotalProgress:function(){var u=0,i=0,f=o.children(),r;n.each(t.percentages,function(n,t){i+=t[0];u+=t[0]*t[1]});r=i?u/i:0;f.eq(0).text(Math.round(r*100)+"%");f.eq(1).css("width",Math.round(r*100)+"%");t.updateStatus()}};window.WebUpLoader=null;n(document).ready(function(){window.WebUpLoader=new c})})(jQuery);
//# sourceMappingURL=WebUpLoader.min.js.map
